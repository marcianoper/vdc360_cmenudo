<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>VDC360¬∞ ‚Äì Cajas Menudo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--ink:#111;--brand:#0a7a3b;--muted:#6b7280;--bg:#f6f7f8;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:16px}
    h2{margin:0 0 10px 0;font-size:18px}
    label{display:block;margin-top:10px;font-size:14px;color:#111}
    input,select,button,textarea{
      width:100%;padding:10px;margin-top:6px;font-size:14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff
    }
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .btn{cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff;border:none}
    .btn-muted{background:#111;color:#fff;border:none}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb;color:#111}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #eef0f2;text-align:left;font-size:14px}
    th{background:#fafafa}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef7f0;color:#0a7a3b;font-size:12px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .danger{color:#b91c1c}
    .ok{color:#166534}
    .center{text-align:center}
    .mini{font-size:12px}
    .sep{height:1px;background:#eee;margin:10px 0}
  </style>
</head>
<body>
<header>
  <h1>VDC360¬∞ ¬∑ Cajas de Menudo (Entradas + Cierre EOD)</h1>
</header>

<main>

  <!-- CONTROLES SUPERIORES -->
  <div class="card">
    <div class="flex">
      <div class="flex" style="gap:6px">
        <label for="fechaTrabajo" class="muted">Fecha de trabajo</label>
        <input id="fechaTrabajo" type="date" />
      </div>
      <span class="right muted">SI = CF d√≠a anterior ¬∑ E = entradas (COUNT) ¬∑ CF = conteo final</span>
    </div>
  </div>

  <div class="row">
    <!-- ENTRADAS -->
    <div class="card">
      <h2>üì¶ Registrar Entrada</h2>
      <div class="row-2">
        <div>
          <label>Marca</label>
          <select id="entMarca"></select>
        </div>
        <div>
          <label>Cantidad de cajas (filas a insertar)</label>
          <input id="entCantidad" type="number" min="1" step="1" value="1" />
        </div>
      </div>
      <div class="row-3">
        <div>
          <label>Proveedor</label>
          <input id="entProveedor" placeholder="(opcional)" />
        </div>
        <div>
          <label>Lote / Ref</label>
          <input id="entLote" placeholder="(opcional)" />
        </div>
        <div>
          <label>Operador</label>
          <input id="entOperador" placeholder="(opcional)" />
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn btn-primary" id="btnGuardarEntrada">Guardar Entrada</button>
        <button class="btn btn-ghost" id="btnWAEntrada">WhatsApp Entrada</button>
        <span class="muted right" id="entStatus">‚Äî</span>
      </div>
      <p class="mini muted">Nota: en tu tabla <b>cajas_menudo_entrada</b> cada fila equivale a <b>1 caja</b> (campo <code>cantidad_cajas=1</code>). Si capturas ‚Äú10‚Äù, insertamos 10 filas.</p>
    </div>

    <!-- CIERRE / CONTEO -->
    <div class="card">
      <h2>üßÆ Cierre Diario (Conteo Final por marca)</h2>
      <div class="row-2">
        <div>
          <label>Encargado del conteo</label>
          <input id="cfEncargado" placeholder="Nombre" />
        </div>
        <div>
          <label>Fecha del conteo</label>
          <input id="cfFecha" type="date" />
        </div>
      </div>

      <table id="cfTabla">
        <thead>
          <tr>
            <th>Marca</th>
            <th class="center">CF (cajas)</th>
          </tr>
        </thead>
        <tbody><!-- filas din√°micas --></tbody>
      </table>

      <div class="flex" style="margin-top:12px">
        <button class="btn btn-primary" id="btnGuardarCF">Guardar Conteo</button>
        <button class="btn btn-ghost" id="btnWAResumen">WhatsApp CF por marca</button>
        <span class="muted right" id="cfStatus">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- TABLEROS -->
  <div class="card">
    <div class="flex">
      <h2>üìä Resumen Diario por Marca</h2>
      <button class="btn btn-muted right" id="btnActualizarResumen">Actualizar</button>
    </div>
    <table id="resumenTabla">
      <thead>
        <tr>
          <th>Marca</th>
          <th>SI</th>
          <th>E</th>
          <th>CF</th>
          <th>S = SI+E‚ÄìCF</th>
        </tr>
      </thead>
      <tbody><!-- din√°mico --></tbody>
    </table>
    <div class="sep"></div>
    <div class="flex">
      <div id="totalesBox" class="pill">Totales ‚Äî SI: 0 ¬∑ E: 0 ¬∑ CF: 0 ¬∑ S: 0</div>
      <span class="right muted" id="alertasBox">Alertas: ‚Äî</span>
    </div>
  </div>

</main>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://bjebybdqcqscouxlinfd.supabase.co";         // <- TU URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZWJ5YmRxY3FzY291eGxpbmZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMjQ3MTksImV4cCI6MjA3MTkwMDcxOX0.mQgWtiYEyJTiF04pdcLv63SqPNrU1Iehws0vKqr82O0";

/* =========================
   CLIENT
========================= */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   HELPERS
========================= */
const $ = (sel) => document.querySelector(sel);
function formatDateISO(d){ const x = new Date(d); const tz=x.getTimezoneOffset()*60000; return new Date(x - tz).toISOString().slice(0,10); }
function todayISO(){ return formatDateISO(new Date()); }
function toast(el, msg){ el.textContent = msg; setTimeout(()=>{el.textContent="‚Äî"}, 4500); }
function errMsg(e){ return e?.message || e?.hint || e?.details || 'Error desconocido'; }

/* üëá Abrir WhatsApp SIN n√∫mero fijo (elige contacto/grupo al abrir) */
function openWA(text){
  const msg = encodeURIComponent(text);
  const url = `https://wa.me/?text=${msg}`;
  const url2 = `https://api.whatsapp.com/send?text=${msg}`;
  const win = window.open(url, "_blank");
  setTimeout(()=>{ if(!win || win.closed) window.open(url2, "_blank"); }, 700);
}

/* =========================
   INIT UI
========================= */
const fechaTrabajo = $("#fechaTrabajo");
const entMarca = $("#entMarca");
const entCantidad = $("#entCantidad");
const entProveedor = $("#entProveedor");
const entLote = $("#entLote");
const entOperador = $("#entOperador");
const entStatus = $("#entStatus");

const cfFecha = $("#cfFecha");
const cfEncargado = $("#cfEncargado");
const cfTablaBody = $("#cfTabla tbody");
const cfStatus = $("#cfStatus");

const resumenTablaBody = $("#resumenTabla tbody");
const totalesBox = $("#totalesBox");
const alertasBox = $("#alertasBox");

fechaTrabajo.value = todayISO();
cfFecha.value = todayISO();

/* =========================
   CARGAR MARCAS ACTIVAS
========================= */
async function loadMarcas(){
  const { data, error } = await supabase
    .from('marcas_menudo')
    .select('nombre')
    .eq('activa', true)
    .order('nombre', { ascending: true });

  if(error){
    console.error(error);
    toast(entStatus, `‚ùå No se pudieron cargar marcas: ${errMsg(error)}`);
    return;
  }

  // Select Entradas
  entMarca.innerHTML = (data||[]).map(m=>`<option value="${m.nombre}">${m.nombre}</option>`).join('');

  // Tabla Conteo
  cfTablaBody.innerHTML = (data||[]).map(m=>{
    return `<tr>
      <td>${m.nombre}</td>
      <td class="center">
        <input type="number" min="0" step="1" class="cf-input" data-marca="${m.nombre}" placeholder="0" />
      </td>
    </tr>`;
  }).join('');
}

/* =========================
   ENTRADAS: INSERT MASIVO
========================= */
async function guardarEntrada(){
  const marca = entMarca.value;
  const cantidad = Math.max(1, parseInt(entCantidad.value||"1",10));
  const proveedor = entProveedor.value || null;
  const lote = entLote.value || null;
  const operador = entOperador.value || null;
  const f = fechaTrabajo.value || todayISO();

  // 1 fila = 1 caja -> cantidad_cajas: 1 (cumple NOT NULL)
  const rows = Array.from({length:cantidad}).map(()=>({
    marca,
    proveedor,
    lote,
    operador,
    fecha_entrada: f,
    cantidad_cajas: 1
  }));

  const { error } = await supabase.from('cajas_menudo_entrada').insert(rows);
  if(error){
    console.error('Insert error:', error);
    toast(entStatus, `‚ùå ${errMsg(error)}`);
    return;
  }
  toast(entStatus, `‚úÖ Guardadas ${cantidad} cajas de ${marca}`);
}

function waEntrada(){
  const marca = entMarca.value;
  const cantidad = Math.max(1, parseInt(entCantidad.value||"1",10));
  const proveedor = entProveedor.value || 'N/D';
  const lote = entLote.value || 'N/D';
  const operador = entOperador.value || 'N/D';
  const f = fechaTrabajo.value || todayISO();

  const texto = [
    "üì¶ ENTRADA REGISTRADA",
    `Marca: ${marca}`,
    `Proveedor: ${proveedor}`,
    `Cantidad: ${cantidad} cajas`,
    `Lote/Ref: ${lote}`,
    `Fecha: ${f}`,
    `Operador: ${operador}`
  ].join('\n');
  openWA(texto);
}

/* =========================
   CIERRE: GUARDAR CF
========================= */
async function guardarCF(){
  const f = cfFecha.value || todayISO();
  const encargado = cfEncargado.value || null;

  const inputs = Array.from(document.querySelectorAll(".cf-input"));
  const rows = inputs
    .map(i => ({ marca:i.dataset.marca, cantidad_reportada: parseInt(i.value||"0",10), fecha_conteo:f, usuario_conteo:encargado }))
    .filter(r => Number.isFinite(r.cantidad_reportada) && r.cantidad_reportada>=0);

  if(rows.length===0){ toast(cfStatus, "‚ö†Ô∏è Nada que guardar"); return; }

  const { error } = await supabase.from('cajas_menudo_conteo_diario').insert(rows);
  if(error){
    console.error(error);
    toast(cfStatus, `‚ùå ${errMsg(error)}`);
    return;
  }
  toast(cfStatus, "‚úÖ Conteo guardado");
}

/* =========================
   RESUMEN: LEER VISTAS
========================= */
async function actualizarResumen(){
  const f = fechaTrabajo.value || todayISO();

  // Por marca
  const { data: marcas, error: e1 } = await supabase
    .from('v_menudo_resumen_diario')
    .select('*')
    .eq('fecha', f)
    .order('marca', { ascending: true });
  if(e1){
    console.error(e1);
    toast(entStatus, `‚ùå Resumen por marca no disponible: ${errMsg(e1)}`);
    return;
  }

  resumenTablaBody.innerHTML = (marcas||[]).map(r=>{
    const klass = (r.si + r.e - r.cf) < 0 ? 'danger' : 'ok';
    return `<tr>
      <td>${r.marca}</td>
      <td>${r.si}</td>
      <td>${r.e}</td>
      <td>${r.cf}</td>
      <td class="${klass}">${r.s}</td>
    </tr>`;
  }).join('');

  // Totales
  const { data: tots, error: e2 } = await supabase
    .from('v_menudo_resumen_totales')
    .select('*')
    .eq('fecha', f)
    .single();
  if(e2 && e2.code!=='PGRST116'){ // PGRST116 = no rows
    console.error(e2);
    toast(entStatus, `‚ùå Totales no disponibles: ${errMsg(e2)}`);
  }

  const t = tots || { si_total:0, e_total:0, cf_total:0, s_total:0 };
  totalesBox.textContent = `Totales ‚Äî SI: ${t.si_total||0} ¬∑ E: ${t.e_total||0} ¬∑ CF: ${t.cf_total||0} ¬∑ S: ${t.s_total||0}`;

  // Alertas
  const { data: al, error: e3 } = await supabase
    .from('v_menudo_alertas')
    .select('*')
    .eq('fecha', f);
  if(e3){
    console.error(e3);
    alertasBox.textContent = "Alertas: (error al consultar)";
  } else {
    alertasBox.textContent = (al && al.length>0)
      ? `Alertas: ${al.length} (revisar salidas negativas)`
      : "Alertas: ‚Äî";
  }
}

/* =========================
   WA RESUMEN ‚Äî SOLO CF POR MARCA
========================= */
async function waResumen(){
  const f = fechaTrabajo.value || todayISO();

  const { data: marcas, error } = await supabase
    .from('v_menudo_resumen_diario')
    .select('marca, cf')
    .eq('fecha', f)
    .order('marca', { ascending: true });

  if (error) {
    console.error(error);
    openWA(`CF por marca no disponible: ${errMsg(error)}`);
    return;
  }

  const lineas = (marcas || []).map(r => `${r.marca}: ${r.cf} cajas`);
  const texto = lineas.length ? lineas.join('\n') : 'Sin datos de CF por marca';
  openWA(texto);
}

/* =========================
   EVENTOS
========================= */
$("#btnGuardarEntrada").addEventListener("click", async ()=>{
  await guardarEntrada();
  await actualizarResumen();
});
$("#btnWAEntrada").addEventListener("click", ()=> waEntrada());
$("#btnGuardarCF").addEventListener("click", async ()=>{
  await guardarCF();
  await actualizarResumen();
});
$("#btnWAResumen").addEventListener("click", ()=> waResumen());
$("#btnActualizarResumen").addEventListener("click", ()=> actualizarResumen());
fechaTrabajo.addEventListener("change", ()=> actualizarResumen());

/* =========================
   BOOT
========================= */
(async function boot(){
  await loadMarcas();
  await actualizarResumen();
})();
</script>
</body>
</html>
